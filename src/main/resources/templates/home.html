<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MEDISUPPLY - Dashboard</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
        }

        .hero-section h1 {
            animation: fadeInDown 1s;
        }

        .hero-section p {
            animation: fadeIn 1.2s;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        }

        .priority-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
        }

        .priority-alta {
            background-color: var(--danger-color);
            color: white;
        }

        .priority-media {
            background-color: var(--warning-color);
            color: white;
        }

        .priority-baja {
            background-color: var(--success-color);
            color: white;
        }

        .btn-floating {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        footer {
            background-color: #1f2937;
            color: #9ca3af;
            padding: 1rem 0;
            text-align: center;
            margin-top: 2rem;
        }

        a:focus,
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 3px solid rgba(99, 102, 241, 0.25);
            outline-offset: 3px;
        }

        .list-group-item .fw-bold {
            font-size: 1rem;
        }

        .list-group-item small {
            color: #6b7280;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-tasks me-2"></i>MediSupply</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="#dashboard"><i
                        class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                <li class="nav-item" sec:authorize="hasAuthority('PERMISSION_READ')">
                    <a class="nav-link" href="#tareas"><i class="fas fa-list me-1"></i>Mis Tareas</a>
                </li>
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a class="nav-link" th:href="@{/admin/users}"><i class="fas fa-users me-1"></i>Usuarios</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span th:text="${currentUser != null} ? ${currentUser.fullName} : 'Usuario'">Usuario</span>
                        <span th:if="${currentUser != null and currentUser.role.name() == 'ADMIN'}"
                              class="badge bg-danger ms-1">ADMIN</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="dropdown-header">
                            <small th:text="${currentUser != null} ? ${currentUser.email} : ''"></small>
                        </li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item" th:href="@{/admin/users}">
                                <i class="fas fa-users-cog me-2"></i>Gestión de Usuarios
                            </a>
                        </li>
                        <li><a class="dropdown-item" th:href="@{/logout}"><i
                                class="fas fa-sign-out-alt me-2"></i>Cerrar
                            Sesión</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<section class="hero-section" id="dashboard" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <div class="container text-center text-lg-start">
        <h1 class="display-5 fw-bold" id="heroGreeting">
            Bienvenido, <span th:text="${currentUser != null} ? ${currentUser.nombre} : 'Usuario'">Usuario</span>
        </h1>
        <p class="lead mb-4" id="heroSummary">
                <span th:if="${currentUser != null and currentUser.role.name() == 'ADMIN'}">
                    Administra el sistema y supervisa todas las tareas.
                </span>
            <span th:unless="${currentUser != null and currentUser.role.name() == 'ADMIN'}">
                    Organiza tu día y no olvides lo importante.
                </span>
        </p>

        <div class="d-flex gap-2 justify-content-center justify-content-lg-start flex-wrap">
            <!-- Botón Nueva Tarea - Solo si tiene permiso CREATE -->
            <button sec:authorize="hasAuthority('PERMISSION_CREATE')"
                    id="newTaskBtn" class="btn btn-light btn-lg"
                    data-bs-toggle="modal" data-bs-target="#taskModal">
                <i class="fas fa-plus me-2"></i>Nueva Tarea
            </button>

            <!-- Ver Tareas - Solo si tiene permiso READ -->
            <a sec:authorize="hasAuthority('PERMISSION_READ')"
               th:href="@{/tasks}" class="btn btn-outline-light btn-lg">
                <i class="fas fa-list me-2"></i>Ver Mis Tareas
            </a>

            <a sec:authorize="hasRole('ADMIN')"
               th:href="@{/admin/users}" class="btn btn-warning btn-lg">
                <i class="fas fa-users-cog me-2"></i>Gestionar Usuarios
            </a>
        </div>
    </div>
</section>

<div class="container mb-4">
    <div class="row text-center">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                <h3 id="statsTotal" class="fw-bold text-primary" th:text="${tasks.size()}">0</h3>
                <p class="text-muted mb-0">Total de Tareas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h3 id="statsPending" class="fw-bold text-warning"
                    th:text="${pendingTasks}">0</h3>
                <p class="text-muted mb-0">Pendientes</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h3 id="statsDone" class="fw-bold text-success"
                    th:text="${completedTasks}">0</h3>
                <p class="text-muted mb-0">Completadas</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                <h3 id="statsOverdue" class="fw-bold text-danger"
                    th:text="${overdueTasks}">0</h3>
                <p class="text-muted mb-0">Vencidas</p>
            </div>
        </div>
    </div>
</div>

<div class="container" id="tareas">
    <div class="row">
        <div class="col-12 mb-4">
            <h3>Mis Tareas</h3>

            <div class="row mb-3 g-2">
                <div class="col-md-8">
                    <input type="text" id="searchTask" class="form-control"
                           placeholder="Buscar por título o descripción...">
                </div>
                <div class="col-md-4">
                    <select id="filterPriority" class="form-select">
                        <option value="">Filtrar por prioridad (Todas)</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                </div>
            </div>


            <div class="list-group" id="taskList">

            </div>
        </div>
    </div>
</div>

<footer class="mt-5 py-5 bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-6 mb-4 mb-md-0">
                <h5 class="fw-bold"><i class="fas fa-tasks me-2"></i>MediSupply Portátil</h5>
                <p class="mb-2">Sistema profesional de gestión de tareas diseñado para aumentar la productividad.
                </p>
                <p class="small mb-0">&copy; 2025 <span class="fw-bold">MediSupply Portátil</span>. Todos los
                    derechos
                    reservados.</p>
            </div>
            <div class="col-md-3 mb-4 mb-md-0">
                <h6 class="fw-bold">Enlaces</h6>
                <ul class="list-unstyled">
                    <li><a href="acerca.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Acerca de</a></li>
                    <li><a href="soporte.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Soporte</a></li>
                    <li><a href="privacidad.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Privacidad</a></li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="fw-bold">Síguenos</h6>
                <div class="d-flex justify-content-center mt-2">
                    <a href="https://facebook.com" target="_blank" class="text-light fs-5 me-3"><i
                            class="fab fa-facebook"></i></a>
                    <a href="https://twitter.com" target="_blank" class="text-light fs-5 me-3"><i
                            class="fab fa-twitter"></i></a>
                    <a href="https://linkedin.com" target="_blank" class="text-light fs-5"><i
                            class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <hr class="border-light my-4">
    </div>
</footer>

<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">Nueva Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">

                <form id="taskForm" th:action="@{/tasks/save}" method="post">
                    <!-- id para editar (si está vacío se crea una nueva) -->
                    <input type="hidden" id="taskId" name="id" value="">

                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Título</label>
                        <input type="text" class="form-control" id="taskTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDesc" class="form-label">Descripción</label>
                        <textarea class="form-control" id="taskDesc" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskPriority" class="form-label">Prioridad</label>
                        <select class="form-select" id="taskPriority" name="priority">
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="taskStatus" class="form-label">Estado</label>
                        <select class="form-select" id="taskStatus" name="status">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Completada">Completada</option>
                            <option value="Vencida">Vencida</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="taskDueDate" class="form-label">Fecha de vencimiento</label>
                        <input type="date" class="form-control" id="taskDueDate" name="dueDate">
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="calendarioModal" tabindex="-1" aria-labelledby="calendarioModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarioModalLabel">Calendario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="perfilModal" tabindex="-1" aria-labelledby="perfilModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="perfilModalLabel">Mi Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Nombre: Raven</p>
                <p>Email: raven@correo.com</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ajustesModal" tabindex="-1" aria-labelledby="ajustesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ajustesModalLabel">Configuración</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>Aquí puedes cambiar ajustes de la aplicación.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    var tasksFromBackend = /*[[${tasksJson}]]*/ '[]';
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Capturar las tareas del HomeController
        const allTasks = typeof tasksFromBackend === 'string' ? JSON.parse(tasksFromBackend) : tasksFromBackend;

        // Función para obtener la clase CSS de prioridad
        function getPriorityClass(priority) {
            switch (priority) {
                case 'Alta':
                    return 'priority-alta';
                case 'Media':
                    return 'priority-media';
                case 'Baja':
                    return 'priority-baja';
                default:
                    return 'priority-baja';
            }
        }

        // Función para formatear fechas
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            // dd/MM/yyyy hh:mm (am/pm) en formato 12 horas
            const datePart = date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const hours = date.getHours();
            let h12 = hours % 12;
            if (h12 === 0) h12 = 12;
            const hh = String(h12).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours < 12 ? 'am' : 'pm';
            return `${datePart} ${hh}:${mm} ${ampm}`;
        }

        // Función para formatear solo fecha (sin hora)
        function formatDateOnly(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('es-ES');
        }

        // Función para renderizar la lista de tareas
        function renderTaskList(tasks) {
            const listContainer = document.getElementById('taskList');

            if (tasks.length === 0) {
                listContainer.innerHTML = '<div class="list-group-item text-muted">No hay tareas registradas.</div>';
                return;
            }

            listContainer.innerHTML = tasks.map(task => `
                    <div class="list-group-item d-flex justify-content-between align-items-start" data-id="${task.id}">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">${task.title}</div>
                            <small class="d-block">${task.description || ''}</small>
                            <div class="mt-2">
                                <span class="badge me-1 ${getPriorityClass(task.priority)}">${task.priority || 'Normal'}</span>
                                <span class="badge bg-secondary me-2">${task.status}</span>
                                <div class="text-muted small mt-1">
                                    <div>Creada: ${formatDate(task.created)}</div>
                                    ${task.dueDate ? `<div>Vence: ${formatDateOnly(task.dueDate)}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            ${window.userPermissions.includes('UPDATE') ? `
                                <form method="post" action="/tasks/toggle/${task.id}" class="d-inline me-1">
                                    <button type="submit" class="btn btn-sm btn-success" title="Alternar completada">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                            ` : ''}
                            ${window.userPermissions.includes('UPDATE') ? `
                                <button type="button" class="btn btn-sm btn-warning me-1 edit-btn" title="Editar" data-id="${task.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            ${window.userPermissions.includes('DELETE') ? `
                                <button type="button" class="btn btn-sm btn-danger delete-btn" title="Eliminar"
                                        data-id="${task.id}" onclick="confirmDelete(${task.id}, '${task.title}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                            </a>
                        </div>
                    </div>
                `).join('');
        }

        // Renderizar todas las tareas al cargar la página
        renderTaskList(allTasks);

        // FullCalendar init (igual que tu original)
        var calendarEl = document.getElementById('calendar');
        if (calendarEl && typeof FullCalendar !== 'undefined') {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                }
            });
            calendar.render();
        }

        // Elementos del modal/form
        const taskModalEl = document.getElementById('taskModal');
        const newTaskBtn = document.getElementById('newTaskBtn');
        const taskIdInput = document.getElementById('taskId');
        const titleInput = document.getElementById('taskTitle');
        const descInput = document.getElementById('taskDesc');
        const priorityInput = document.getElementById('taskPriority');
        const statusInput = document.getElementById('taskStatus');
        const dueDateInput = document.getElementById('taskDueDate');

        // Cuando se abre el modal desde "Nueva Tarea" limpiamos formulario
        newTaskBtn.addEventListener('click', () => {
            taskIdInput.value = '';
            titleInput.value = '';
            descInput.value = '';
            priorityInput.value = 'Baja';
            statusInput.value = 'Pendiente';
            dueDateInput.value = '';
            document.getElementById('taskModalLabel').textContent = 'Nueva Tarea';
        });

        // Manejo de botones "Editar" (se delega eventos)
        document.getElementById('taskList').addEventListener('click', function (e) {
            const btn = e.target.closest('.edit-btn');
            if (!btn) return;
            const id = btn.getAttribute('data-id') || btn.closest('[data-id]')?.getAttribute('data-id');
            if (!id) return;

            // Traer tarea desde backend (endpoint /tasks/edit/{id} devuelve JSON)
            fetch('/tasks/edit/' + id)
                .then(res => {
                    if (!res.ok) throw new Error('No se pudo obtener la tarea');
                    return res.json();
                })
                .then(task => {
                    // Rellenar formulario
                    taskIdInput.value = task.id ? task.id : '';
                    titleInput.value = task.title ? task.title : '';
                    descInput.value = task.description ? task.description : '';
                    priorityInput.value = task.priority ? task.priority : 'Baja';
                    statusInput.value = task.status ? task.status : 'Pendiente';
                    if (task.dueDate) {
                        // dueDate viene en formato yyyy-MM-dd -> compatible con input type=date
                        dueDateInput.value = task.dueDate;
                    } else {
                        dueDateInput.value = '';
                    }
                    document.getElementById('taskModalLabel').textContent = 'Editar Tarea';
                    // Mostrar modal
                    const modal = new bootstrap.Modal(taskModalEl);
                    modal.show();
                })
                .catch(err => {
                    alert('Error al cargar la tarea para edición.');
                    console.error(err);
                });
        });

        // Búsqueda y filtrado usando la variable allTasks del HomeController
        const searchTask = document.getElementById('searchTask');
        const filterPriority = document.getElementById('filterPriority');
        const listContainer = document.getElementById('taskList');

        function filterRender() {
            const text = (searchTask.value || '').toLowerCase();
            const priority = filterPriority.value;

            // Filtrar las tareas usando la variable allTasks del backend
            const filteredTasks = allTasks.filter(task => {
                const matchesText = task.title.toLowerCase().includes(text) ||
                    task.description.toLowerCase().includes(text);
                const matchesPriority = !priority || task.priority === priority;
                return matchesText && matchesPriority;
            });

            // Re-renderizar la lista con las tareas filtradas
            if (filteredTasks.length === 0 && (text || priority)) {
                listContainer.innerHTML = '<div class="list-group-item text-muted no-match-msg">No hay tareas que coincidan con los filtros.</div>';
            } else {
                renderTaskList(filteredTasks);
            }
        }

        searchTask.addEventListener('input', filterRender);
        filterPriority.addEventListener('change', filterRender);

    });

    // Variables globales de permisos del usuario
    window.userPermissions = [];

    /*[# th:if="${currentUser != null and currentUser.permissions != null}"]*/
    /*[# th:each="permission : ${currentUser.permissions}"]*/
    window.userPermissions.push('/*[[${permission}]]*/');
    /*[/]*/
    /*[/]*/

    // Función para confirmar eliminación con SweetAlert2
    function confirmDelete(taskId, taskTitle) {
        Swal.fire({
            title: '¿Eliminar Tarea?',
            html: `¿Estás seguro de que quieres eliminar la tarea <strong>${taskTitle}</strong>?<br><br>Esta acción no se puede deshacer.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // Crear formulario para enviar POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/tasks/delete/${taskId}`;
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
</script>

</body>

</html>