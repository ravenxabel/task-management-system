<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MEDISUPPLY - Tareas</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .main-content {
            min-height: calc(100vh - 200px);
            padding: 2rem 0;
        }

        .table th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }

        .badge-priority-alta {
            background-color: var(--danger-color);
        }

        .badge-priority-media {
            background-color: var(--warning-color);
        }

        .badge-priority-baja {
            background-color: var(--success-color);
        }

        .btn-group .btn {
            margin-right: 0.25rem;
        }

        .btn-group .btn:last-child {
            margin-right: 0;
        }

        footer {
            background-color: #1f2937;
            color: #9ca3af;
            padding: 1rem 0;
            text-align: center;
            margin-top: 2rem;
        }

        a:focus,
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 3px solid rgba(99, 102, 241, 0.25);
            outline-offset: 3px;
        }

        .list-group-item .fw-bold {
            font-size: 1rem;
        }

        .list-group-item small {
            color: #6b7280;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand fw-bold" th:href="@{/home}"><i class="fas fa-tasks me-2"></i>MediSupply</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/home}"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                </li>
                <li class="nav-item" sec:authorize="hasAuthority('PERMISSION_READ')">
                    <a class="nav-link active" href="#"><i class="fas fa-list me-1"></i>Mis Tareas</a>
                </li>
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a class="nav-link" th:href="@{/admin/users}"><i class="fas fa-users me-1"></i>Usuarios</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span th:text="${currentUser != null} ? ${currentUser.fullName} : 'Usuario'">Usuario</span>
                        <span th:if="${currentUser != null and currentUser.role.name() == 'ADMIN'}"
                              class="badge bg-danger ms-1">ADMIN</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="dropdown-header">
                            <small th:text="${currentUser != null} ? ${currentUser.email} : ''"></small>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li sec:authorize="hasRole('ADMIN')">
                            <a class="dropdown-item" th:href="@{/admin/users}">
                                <i class="fas fa-users-cog me-2"></i>Gestión de Usuarios
                            </a>
                        </li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form th:action="@{/logout}" method="post" class="m-0">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión
                                </button>
                            </form>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="main-content">
    <div class="container">

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Header de la página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1"><i class="fas fa-list-alt me-2 text-primary"></i>Gestión de Tareas</h1>
            <p class="text-muted mb-0">Administra y organiza todas tus tareas</p>
        </div>
        <!-- Botón para agregar nueva tarea -->
        <div sec:authorize="hasAuthority('PERMISSION_CREATE')">
            <a th:href="@{/tasks/new}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i> Nueva Tarea
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                        <th class="text-center" style="width: 60px;">#</th>
                        <th>Título</th>
                        <th>Descripción</th>
                        <th style="width: 120px;">Fecha Límite</th>
                        <th class="text-center" style="width: 100px;">Prioridad</th>
                        <th class="text-center" style="width: 120px;">Estado</th>
                        <th class="text-center" style="width: 180px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="task : ${tasks}" class="align-middle">
                        <td class="text-center fw-bold text-muted" th:text="${task.id}"></td>
                        <td>
                            <div class="fw-semibold" th:text="${task.title}"></div>
                        </td>
                        <td>
                            <span th:text="${task.description}" class="text-muted"></span>
                        </td>
                        <td class="text-center">
                            <small th:text="${#temporals.format(task.dueDate, 'dd/MM/yyyy')}" class="text-muted"></small>
                        </td>
                        <td class="text-center">
                            <span class="badge px-3 py-2"
                                  th:classappend="${task.priority == 'Alta' ? ' badge-priority-alta' :
                                                  (task.priority == 'Media' ? ' badge-priority-media' : ' badge-priority-baja')}">
                                <i class="fas fa-flag me-1"></i>
                                <span th:text="${task.priority}"></span>
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge px-3 py-2"
                                  th:classappend="${task.status == 'Completada' ? ' bg-success' :
                                                  (task.status == 'En progreso' ? ' bg-primary' : ' bg-secondary')}">
                                <i th:class="${task.status == 'Completada' ? 'fas fa-check me-1' :
                                              (task.status == 'En progreso' ? 'fas fa-spinner me-1' : 'fas fa-clock me-1')}"></i>
                                <span th:text="${task.status}"></span>
                            </span>
                        </td>
            <td class="text-center">
                <div class="btn-group" role="group">
                    <div sec:authorize="hasAuthority('PERMISSION_UPDATE')">
                        <button type="button" class="btn btn-warning btn-sm edit-task-btn"
                                th:data-task-id="${task.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                    <div sec:authorize="hasAuthority('PERMISSION_DELETE')">
                        <button type="button" class="btn btn-danger btn-sm delete-task-btn"
                                th:data-task-id="${task.id}"
                                th:data-task-title="${task.title}">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
                <div sec:authorize="!hasAuthority('PERMISSION_UPDATE') and !hasAuthority('PERMISSION_DELETE')">
                    <span class="text-muted">Sin permisos</span>
                </div>
            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-4 text-center">
        <a href="/home" class="btn btn-secondary">⬅ Volver al Home</a>
    </div>
</div>


<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar la tarea "<span id="taskNameToDelete"></span>"?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Editar Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTaskForm" method="POST">
                <div class="modal-body">
                    <input type="hidden" id="editTaskId" name="id">

                    <div class="mb-3">
                        <label for="editTitle" class="form-label">Título *</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDueDate" class="form-label">Fecha Límite *</label>
                                <input type="date" class="form-control" id="editDueDate" name="dueDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPriority" class="form-label">Prioridad</label>
                                <select class="form-select" id="editPriority" name="priority">
                                    <option value="Alta">Alta</option>
                                    <option value="Media">Media</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Estado</label>
                        <select class="form-select" id="editStatus" name="status">
                            <option value="Pendiente">Pendiente</option>
                            <option value="En progreso">En progreso</option>
                            <option value="Completada">Completada</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Actualizar Tarea</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<footer class="mt-5 py-5 bg-dark text-light">
    <div class="container">
        <div class="row">
            <div class="col-md-6 mb-4 mb-md-0">
                <h5 class="fw-bold"><i class="fas fa-tasks me-2"></i>MediSupply Portátil</h5>
                <p class="mb-2">Sistema profesional de gestión de tareas diseñado para aumentar la productividad.
                </p>
                <p class="small mb-0">&copy; 2025 <span class="fw-bold">MediSupply Portátil</span>. Todos los
                    derechos
                    reservados.</p>
            </div>
            <div class="col-md-3 mb-4 mb-md-0">
                <h6 class="fw-bold">Enlaces</h6>
                <ul class="list-unstyled">
                    <li><a href="acerca.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Acerca de</a></li>
                    <li><a href="soporte.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Soporte</a></li>
                    <li><a href="privacidad.html" class="text-decoration-none text-light-50 d-block py-1"><i
                            class="fas fa-angle-right me-2"></i>Privacidad</a></li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="fw-bold">Síguenos</h6>
                <div class="d-flex justify-content-center mt-2">
                    <a href="https://facebook.com" target="_blank" class="text-light fs-5 me-3"><i
                            class="fab fa-facebook"></i></a>
                    <a href="https://twitter.com" target="_blank" class="text-light fs-5 me-3"><i
                            class="fab fa-twitter"></i></a>
                    <a href="https://linkedin.com" target="_blank" class="text-light fs-5"><i
                            class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <hr class="border-light my-4">
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let taskIdToDelete = null;

    // Agregar event listeners a los botones de eliminar y editar
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.delete-task-btn');
        const editButtons = document.querySelectorAll('.edit-task-btn');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                const taskTitle = this.getAttribute('data-task-title');
                confirmDelete(taskId, taskTitle);
            });
        });

        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                editTask(taskId);
            });
        });
    });

    function confirmDelete(taskId, taskTitle) {
        taskIdToDelete = taskId;
        document.getElementById('taskNameToDelete').textContent = taskTitle;
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (taskIdToDelete) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/tasks/delete/${taskIdToDelete}`;
            document.body.appendChild(form);
            form.submit();
        }
    });

    function editTask(taskId) {
        // Realizar petición AJAX para obtener los datos de la tarea
        fetch(`/tasks/edit/${taskId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener datos de la tarea');
                }
                return response.json();
            })
            .then(task => {
                // Llenar el formulario con los datos de la tarea
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTitle').value = task.title;
                document.getElementById('editDescription').value = task.description || '';
                document.getElementById('editDueDate').value = task.dueDate || '';
                document.getElementById('editPriority').value = task.priority || 'Media';
                document.getElementById('editStatus').value = task.status || 'Pendiente';

                // Configurar la acción del formulario
                document.getElementById('editTaskForm').action = `/tasks/save`;

                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los datos de la tarea. Por favor, intenta nuevamente.');
            });
    }
</script>

</body>
</html>
